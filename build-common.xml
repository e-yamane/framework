<?xml version="1.0" encoding="Shift_JIS"?>

<project name="common-project" basedir="." default="makeBean">
  <dirname property="my.build.dir" file="${ant.file}" />

  <!-- フレームワークディレクトリ関連 -->
  <property name="framework.vendor"                 value="Rough Diamond Co.,Ltd" />
  <property name="framework.root"                   value="${my.build.dir}/../framework" />
  <property name="framework.work.classes.dir"       value="${framework.root}/work/classes" />
  <property name="framework.src.dir"                value="${framework.root}/src/java" />
  <property name="framework.lib.root"               value="${framework.root}/libs" />
  <property name="framework.java.version"           value="1.6" />
  <property name="framework.compile.debug"          value="on" />
  <property name="framework.src.encoding"           value="MS932" />
  <property name="framework.ant.extention.version"  value="1.0" />
  <property name="framework.dist.dir"               value="../framework/target"/>
  <property name="framework.classes.dir"            value="${framework.dist.dir}/classes" />


  <property name="war.name"               value="ROOT" />
  <property name="release.dir"            value="release" />
  <property name="src.dir"                value="${my.build.dir}/src/java" />
  <property name="web.root.dir"           value="${my.build.dir}/webapp" />
  <property name="lib.dir"                value="${web.root.dir}/WEB-INF/lib" />
  <property name="classes.dir"            value="${web.root.dir}/WEB-INF/classes" />
  <property name="other.src.dir"          value="${my.build.dir}/src/other" />
  <property name="other.lib.dir"          value="${my.build.dir}/etc/otherlib" />
  <property name="conf.dir"               value="${my.build.dir}/conf" />
  <property name="resource.dir"           value="${my.build.dir}/src/resource" />
  <property name="schema.property.file"   value="schemaResources.properties" />
  <property name="src.encoding"           value="Windows-31J" />

  <!-- データベース関連 -->
  <property name="export.dir"             value="${my.build.dir}/etc/export" />
  <property name="table.doc.dir"          value="${my.build.dir}/doc/table" />
  <property name="torque.schema.dir"      value="${my.build.dir}/etc/schema" />
  <property name="torque.sql.dir"         value="${my.build.dir}/etc/sql" />
  <property name="sql.createtables"       value="${torque.sql.dir}/*-schema.sql" />
  <property name="sql.addalter"           value="${torque.sql.dir}/*-schema-fk.sql" />
  <property name="sql.schema"             value="${torque.schema.dir}/*-schema.xml" />

  <!-- テスト関連 -->
  <property name="test.root.dir"          value="${my.build.dir}/test" />
  <property name="test.work.dir"          value="${test.root.dir}/work" />
  <property name="test.classes.dir"       value="${test.work.dir}/classes" />
  <property name="test.src.dir"           value="${my.build.dir}/src/test" />
  <property name="result.dir"             value="${test.root.dir}/result" />
  <property name="report.dir"             value="testRreport" />
  <property name="coverage.dir"           value="coverage" />
  <property name="junit.src.pattern"      value="**/*Test.java" />
  <property name="cobertura.ser"          value="${test.work.dir}/cobertura.ser" />


  <property name="test.filed.flag"        value="${test.work.dir}/.testFailed" />
  <property name="test.compiled.flag"     value="${test.work.dir}/.testCompiled" />
  <property name="test.initialized.flag"  value="${test.work.dir}/.testInitialized" />
  <property name="test.web.root"          value="${test.work.dir}/webresource" />

  <!-- コンパイル周り -->
  <property name="compile.debug" value="on"/>
  <property name="compile.optimize" value="off"/>
  <property name="compile.deprecation" value="off"/>
  <property name="compile.java.version" value="1.6" />

  <!-- ライブラリ取得先 -->
  <property name="lib.publisher" value="http://www.ibiblio.org/maven" />

  <!-- JavaDoc出力先 -->
  <property name="javadoc.dir" value="${my.build.dir}/doc/api" />

  <path id="real.src.path.default">
    <pathelement location="${src.dir}" />
  </path>

  <path id="test.src.path.default">
    <path refid="real.src.path.default"/>
    <pathelement location="${test.src.dir}" />
  </path>

  <!-- servletAPIのバージョンで異なる -->
  <path id="servletapi.path">
    <fileset dir="${other.lib.dir}">
      <include name="servlet-api.jar" />
      <include name="jsp-api.jar" />
    </fileset>
  </path>

  <path id="classpath.real">
    <fileset dir="${lib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <path refid="servletapi.path"/>
  </path>

  <path id="framework.path">
    <pathelement location="${framework.work.classes.dir}" />
    <fileset dir="${framework.lib.root}">
      <include name="**/*.jar" />
    </fileset>
  </path>

  <path id="classpath.all">
    <path refid="classpath.real"/>
    <fileset dir="${other.lib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <path refid="framework.path" />
  </path>

  <path id="wsdl2java.path">
    <pathelement location="${classes.dir}" />
    <fileset dir="${other.lib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <path refid="framework.path"/>
  </path>

  <macrodef name="findBaseAntFile">
    <sequential>
      <script language="javascript">
          <![CDATA[
            var map = project.getProperties();
            var antFile = map.get("ant.file");
            var ite = map.entrySet().iterator();
            while(ite.hasNext()) {
              var entry = ite.next();
              if(entry.getKey().startsWith("ant.file.") && !entry.getKey().equals("ant.file.common-project")) {
                antFile = entry.getValue();
                break;
              }
            }
            project.setProperty("baseAntFile", antFile);
          ]]>
      </script>
      <echo message="${baseAntFile}" />
    </sequential>
  </macrodef>

  <target name="ant-extention-check">
    <available file="${framework.lib.root}/common/rd-ant-ext-${framework.ant.extention.version}.jar" property="ant.ext.jar.present" />
  </target>

  <target name="ant-extention-make" unless="ant.ext.jar.present">
    <mkdir dir="${framework.work.classes.dir}" />
    <delete dir="${framework.work.classes.dir}" />
    <mkdir dir="${framework.work.classes.dir}" />
    <javac
        srcdir="${framework.src.dir}"
        source="${framework.java.version}"
        target="${framework.java.version}"
        destdir="${framework.work.classes.dir}"
        debug="${framework.compile.debug}"
        encoding="${framework.src.encoding}"
    >
      <include name="jp/rough_diamond/ant/**/*.java" />
      <include name="jp/rough_diamond/tools/**/*.java" />
      <include name="org/dbunit/**/*.java" />
      <classpath>
        <fileset dir="${framework.lib.root}">
          <include name="**/*.jar" />
        </fileset>
      </classpath>
    </javac>
    <copy todir="${framework.work.classes.dir}">
      <fileset dir="${framework.src.dir}">
        <exclude name="**/.svn" />
        <exclude name="**/*.java" />
        <include name="jp/rough_diamond/ant/**/*" />
        <include name="jp/rough_diamond/tools/**/*" />
        <include name="org/dbunit/**/*" />
      </fileset>
    </copy>
    <jar destfile="${framework.lib.root}/common/rd-ant-ext-${framework.ant.extention.version}.jar" 
        basedir="${framework.work.classes.dir}">
      <manifest>
        <attribute name="Implementation-Vendor"   value="${framework.vendor}"/>
        <attribute name="Implementation-Title"    value="Rough Diamond Framework Ant Tasks"/>
        <attribute name="Implementation-Version"  value="${framework.ant.extention.version}"/>
      </manifest>
    </jar>
  </target>

  <target name="init-task" depends="ant-extention-check, ant-extention-make">
    <taskdef name="propertyChecker" classpathref="framework.path"
              classname="jp.rough_diamond.ant.taskdefs.PropertyCheckerTask" />
    <taskdef name="hibernatedoclet" classpathref="framework.path"
              classname="jp.rough_diamond.ant.taskdefs.HibernateDocletTaskExt" />
    <taskdef name="dbunit" classpathref="classpath.all"
                      classname="org.dbunit.ant.DbUnitTask" />
    <taskdef name="beanGen" classpathref="framework.path"
                                          classname="jp.rough_diamond.ant.taskdefs.BeanGenerator" />
    <taskdef name="getWSDL" classpathref="framework.path"
        classname="jp.rough_diamond.ant.taskdefs.GetAndMakeWSDLTask" />
    <taskdef name="wsdl2java" classpathref="framework.path"
        classname="jp.rough_diamond.ant.taskdefs.WSDL2JavaExt" />
    <taskdef name="makeCXFService" classpathref="framework.path"
        classname="jp.rough_diamond.ant.taskdefs.ServiceGeneratorTask" />
  </target>

  <target name="makeBean" depends="init-task" description="JavaBeansを作成する">
    <beanGen root="${src.dir}" input="beanDef/beanDef.xml" />
    <echo message="Eclipse上で実行している場合は、F5を押して最新状態にしてください。" />
  </target>

  <target name="copyTorque-gen" description="Torque-Genのパッチを当てたものを当該プロジェクトへコピーする">
    <ant antfile="../torque-gen-patch/build.xml" target="copyTorque-gen" />
  </target>

  <target name="makeClientStub" description="WSDLをサーバから取得しスタブモジュールを作成する">
    <antcall target="getWSDL" />
    <antcall target="wsdl2java" />
  </target>

  <target name="filter-check" unless="filtering.filename" >
    <property name="tmpName" value="${user.name}" />
    <property name="confDir" value="${conf.dir}" />
    <echo message="${tmpName}" />
    <script language="javascript">
        <![CDATA[
          project.setProperty("filtering.filename", confDir + "/filtering." + tmpName.replace("-", "_") + ".properties");
        ]]>
    </script>
  </target>

  <target name="filter-exists" if="filtering.filename" >
    <echo message="loading Environment InjecttionFile:[${filtering.filename}]" />
    <available file="${filtering.filename}" property="filtering.filename.present" />
    <antcall target="filter-nonexists-msg" />
  </target>

  <target name="filter-nonexists-msg" unless="filtering.filename.present" >
    <echo message="${filtering.filename}が存在しません。" />
  </target>

  <target name="getWSDL">
    <condition property="wsdl.dir" value="${my.build.dir}/etc/wsdl" >
      <not>
        <isset property="wsdl.dir" />
      </not>
    </condition>
    <condition property="di.container.type" value="jp.rough_diamond.commons.di.SpringFramework" >
      <not>
        <isset property="di.container.type" />
      </not>
    </condition>
    <condition property="di.config.path" value="beans.xml" >
      <not>
        <isset property="di.config.path" />
      </not>
    </condition>
    <getWSDL wsdlStorageDir="${wsdl.dir}" classPathRef="wsdl2java.path" diContainerType="${di.container.type}" diConfig="${di.config.path}" />
  </target>

  <target name="wsdl2java">
    <condition property="wsdl.dir" value="${my.build.dir}/etc/wsdl" >
      <not>
        <isset property="wsdl.dir" />
      </not>
    </condition>
    <condition property="cxf.dest.dir" value="${my.build.dir}/src/java" >
      <not>
        <isset property="cxf.dest.dir" />
      </not>
    </condition>
    <condition property="cxf.stub.package" value="cxf.stub" >
      <not>
        <isset property="cxf.stub.package" />
      </not>
    </condition>
    <condition property="cxf.mule.client.config" value="${my.build.dir}/src/java/mule/edi-client-config.xml" >
      <not>
        <isset property="cxf.mule.client.config" />
      </not>
    </condition>
    <condition property="mule.version" value="2.1" >
      <not>
        <isset property="mule.version" />
      </not>
    </condition>
    <wsdl2java
      wsdldir="${wsdl.dir}"
      srcdir="${cxf.dest.dir}" 
      rootPackage="${cxf.stub.package}" 
      muleConfigFile="${cxf.mule.client.config}"
      classPathRef="wsdl2java.path" 
      version="${mule.version}" />
  </target>

  <target name="makeCXFService" description="サービスの定義に基づいてサーバ側で必要なリソースを作成する">
    <condition property="cxf.service.file" value="${my.build.dir}/etc/serviceDef/services.xml" >
      <not>
        <isset property="cxf.service.file" />
      </not>
    </condition>
    <condition property="cxf.dest.dir" value="${my.build.dir}/src/java" >
      <not>
        <isset property="cxf.dest.dir" />
      </not>
    </condition>
    <condition property="cxf.mule.server.config" value="${my.build.dir}/src/java/mule/edi-server-config.xml" >
      <not>
        <isset property="cxf.mule.server.config" />
      </not>
    </condition>
    <condition property="mule.version" value="2.1" >
      <not>
        <isset property="mule.version" />
      </not>
    </condition>
    <makeCXFService
      input="${cxf.service.file}"
      srcdir="${cxf.dest.dir}"
      muleConfigFile="${cxf.mule.server.config}" 
      version="${mule.version}" />
  </target>

  <target name="execAnt">
    <echo message="${ant.home}" />
    <echo message="${basedir}" />
    <exec executable="${java.home}/bin/java">
      <arg value="-classpath" />
      <arg value="${java.class.path}" />
      <arg value="org.apache.tools.ant.launch.Launcher" />
      <arg value="-f" />
      <arg value="${build.file}" />
      <arg value="${exec.target}" />
    </exec>
  </target>

  <target name="makeSchemaAccessor" description="テーブルレイアウト、create table文、Javaソース、マッピングファイル、hibernateConfigを作成する">
    <filter token="src.dir"                     value="${src.dir}" />
    <filter token="table.doc.dir"               value="${table.doc.dir}" />
    <filter token="torque.schema.property.dir"  value="${resource.dir}" />
    <filter token="torque.schema.property.file" value="${schema.property.file}" />
    <filter token="torque.schema.dir"           value="${torque.schema.dir}" />
    <filter token="torque.sql.dir"              value="${torque.sql.dir}" />
    <filter filtersfile="${my.build.dir}/middlegen.properties" />

    <copy file="${framework.root}/build-torque.properties" tofile="torque-gen/build.properties" filtering="true" overwrite="true" />
    <replace file="torque-gen/build.properties" token="\" value="/" />

    <echo message="Create Table文を作成します。" />
    <antcall target="execAnt">
      <param name="build.file"  value="${basedir}/torque-gen/build-torque.xml" />
      <param name="exec.target" value="sql" />
    </antcall>
    <echo message="テーブルレイアウトを作成します。" />
    <antcall target="execAnt">
      <param name="build.file"  value="${basedir}/torque-gen/build-torque.xml" />
      <param name="exec.target" value="doc" />
    </antcall>
    <echo message="DAOクラスを作成します。" />
    <antcall target="execAnt">
      <param name="build.file"  value="${basedir}/torque-gen/build-torque.xml" />
      <param name="exec.target" value="hibernate-java" />
    </antcall>
    <echo message="スキーマプロパティを作成します。" />
    <antcall target="execAnt">
      <param name="build.file"  value="${basedir}/torque-gen/build-torque.xml" />
      <param name="exec.target" value="schema-properties" />
    </antcall>
    <antcall target="execAnt">
      <param name="build.file"  value="${basedir}/build.xml" />
      <param name="exec.target" value="hibernatedoclet" />
    </antcall>
    <echo message="${filtering.filename}" />
    <antcall target="refreshProperties" />
    <echo message="Eclipse上で実行している場合は、F5を押して最新状態にしてください。" />
  </target>

  <target name="refreshProperties" depends="filter-check, filter-exists" if="filtering.filename.present">
    <findBaseAntFile />
    <ant antfile="${baseAntFile}" target="makeConfig">
      <property name="filtering.filename" value="${filtering.filename}" />
    </ant>
  </target>

  <!-- JavaのソースコードからHibernateのマッピングファイルを作成する -->
  <target name="hibernatedoclet" depends="init-task">
    <property file="./middlegen.properties" />
    <condition property="hibernate.otherResources" value="" >
      <not>
        <isset property="hibernate.otherResources" />
      </not>
    </condition>
    <condition property="hibernate.fileset.dirs" value="${src.dir}" >
      <not>
        <isset property="hibernate.fileset.dirs" />
      </not>
    </condition>
    <condition property="hibernate.pattern" value="**/entity/**/*.java" >
      <not>
        <isset property="hibernate.pattern" />
      </not>
    </condition>
    <echo message="${hibernate.otherResources}" />
    <hibernatedoclet destdir="${src.dir}"
      excludedtags="@version, @author, @todo"
      force="true"
      mergedir="${classes.dir}"
      verbose="false"
      fileSetDirs="${hibernate.fileset.dirs}"
      >
      <hibernate version="3.0"/>
      <hibernatecfg 
          dialect="${hibernate.dialect}"
          jdbcUrl="${hibernate.connection.url}"
          driver="${hibernate.connection.driver_class}"
          userName="${hibernate.connection.username}"
          password="${hibernate.connection.password}"
          showSql="${hibernate.show_sql}"
          useOuterjoin="true"
          destDir="${src.dir}"
          version="3.0"
          destinationFile="hibernate.cfg.xml"
          otherResources="${hibernate.otherResources}"
      >
        <otherProperty name="connection.provider_class"       value="${hibernate.connection.provider_class}" />
        <otherProperty name="connection.pool_size"            value="${hibernate.connection.pool_size}" />
        <otherProperty name="connection.c3p0.min_size"        value="${hibernate.connection.c3p0.min_size}" />
        <otherProperty name="connection.c3p0.max_size"        value="${hibernate.connection.c3p0.max_size}" />
        <otherProperty name="connection.c3p0.timeout"         value="${hibernate.connection.c3p0.timeout}" />
        <otherProperty name="connection.c3p0.max_statements"  value="${hibernate.connection.c3p0.max_statements}" />
        <otherProperty name="default_schema"                  value="${hibernate.default_schema}" />
      </hibernatecfg>
    </hibernatedoclet>
  </target>

  <target name="DB-init" depends="init-task" description="自動生成されたCreate Table文を実行する">
    <antcall target="DB-clear-1" />
    <antcall target="DB-clear-2" />
  </target>

  <target name="DB-clear-1" depends="init-task">
    <property file="./middlegen.properties" />
    <dbunit driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" 
            userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            schema="${hibernate.schema}">
      <query file="${torque.sql.dir}/preinit.sql" encoding="Shift_JIS" />
      <query file="${sql.createtables}" encoding="Shift_JIS" />
    </dbunit>
  </target>

  <target name="DB-clear-2" depends="init-task">
    <property file="./middlegen.properties" />
    <dbunit driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" 
            userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            schema="${hibernate.schema}">
      <query file="${sql.addalter}" encoding="Shift_JIS" />
      <query file="${torque.sql.dir}/postinit.sql" encoding="Shift_JIS" />
    </dbunit>
  </target>

  <target name="DB-export" depends="init-task" description="DBをエクスポートする">
    <mkdir dir="${export.dir}" />
    <property file="./middlegen.properties" />
    <echo message="${sql.schema}" />
    <dbunit driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" 
            userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            schema="${hibernate.default_schema}">
      <export4TorqueSchema dest="${export.dir}/{0}.xml" format="xml" schema="${sql.schema}" />
    </dbunit>
  </target>

  <target name="DB-export-excel" depends="init-task" description="DBをExcelへエクスポートする">
    <mkdir dir="${export.dir}" />
    <property file="./middlegen.properties" />
    <dbunit driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" 
            userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            schema="${hibernate.default_schema}">
      <export4TorqueSchema dest="${export.dir}/{0}.xls" format="excel" schema="${sql.schema}" />
    </dbunit>
  </target>

  <target name="DB-recover" depends="init-task" description="エクスポートしたデータをインポートする">
    <antcall target="DB-clear-1" />
    <property file="./middlegen.properties" />
    <dbunit driver="${hibernate.connection.driver_class}" url="${hibernate.connection.url}" 
            userid="${hibernate.connection.username}" password="${hibernate.connection.password}"
            schema="${hibernate.default_schema}">
      <operation type="INSERT" src="${export.dir}/./*.xml" format="xml"/>
    </dbunit>
    <antcall target="DB-clear-2" />
  </target>

  <target name="doContinuousIntegration" description="継続的インテグレーションを行う">
    <property name="filtering.filename" value="${conf.dir}/filtering.ci.properties" />
    <antcall target="doCopyTorqueGen" />
    <antcall target="ci-preprocess" />
    <antcall target="makeCIConfig" />
    <antcall target="makeSchemaAccessor" />
    <antcall target="DB-init" />
    <antcall target="test" />
    <antcall target="ci-postprocess" />
  </target>

  <target name="doCopyTorqueGen" unless="ci.skip.torquegen">
    <ant antfile="../torque-gen-patch/build.xml" target="dist" inheritAll="false"/>
    <antcall target="copyTorque-gen" />
  </target>

  <target name="ci-preprocess" if="ci.preprocess.name">
    <antcall target="${ci.preprocess.name}" />
  </target>

  <target name="ci-postprocess" if="ci.postprocess.name">
    <antcall target="${ci.postprocess.name}" />
  </target>

  <target name="makeCIConfig" unless="ci.skip.ei">
    <antcall target="makeConfig" />
  </target>

  <target name="test.prepare">
    <mkdir dir="${test.work.dir}" />
    <mkdir dir="${test.classes.dir}" />
    <delete file="${cobertura.ser}" />
    <delete>
      <fileset dir="${test.classes.dir}" includes="**/*" />
    </delete>
    <mkdir dir="${result.dir}" />
    <delete>
      <fileset dir="${result.dir}" includes="**/*" />
    </delete>
    <condition property="test.src.path.name" value="test.src.path.default">
      <not>
        <isreference refid="test.src.path" />
      </not>
    </condition>
    <condition property="test.src.path.name" value="test.src.path">
      <isreference refid="test.src.path" />
    </condition>
  </target>
  
  <target name="test.compile" depends="test.prepare">
    <echo message="${test.src.path.name}" />
    <echo message="${lib.dir}" />
    <antcall target="do.compile">
      <param name="compile.src.roots"     value="${test.src.path.name}" />
      <param name="compile.classpath"     value="classpath.all" />
      <param name="compile.dest.dir"      value="${test.classes.dir}" />
      <param name="copy.resource.target"  value="copyAllResources" />
    </antcall>
  </target>

  <target name="do.compile" depends="initAspectJTask">
    <iajc
        destDir="${compile.dest.dir}"
        deprecation="yes"
        debug="true"
        source="${compile.java.version}"
        target="${compile.java.version}"
        encoding="${src.encoding}"
    >
      <sourceroots>
        <path refid="${compile.src.roots}"/>
      </sourceroots>
      <classpath>
        <path refid="${compile.classpath}"/>
      </classpath>
    </iajc>
    <antcall target="${copy.resource.target}">
      <param name="resource.dest.dir" value="${compile.dest.dir}" />
    </antcall>
  </target>

  <!--
    リリースモジュールを作成する
    一度なくしたいんだけど、コンパイルエラーになるので
    非公開タスクとして残す
  -->
  <target name="makeReleaseModule">
    <property file="./dairy-build.properties" />
    <antcall target="makeReleaseConfig" />
    <mkdir dir="${release.dir}" />
    <delete>
      <fileset dir="${release.dir}/" includes="**/*"/>
    </delete>
    <mkdir dir="${release.dir}/work" />
    <exec dir="${release.dir}/work" executable="svn">
      <arg line="export --force --no-auth-cache ${svn.url} ."/>
    </exec>
    <ant antfile="build.xml" dir="${release.dir}/work">
      <target name="makeReleaseConfig" />
<!--
      <target name="get-deps" />
-->
      <target name="compile-other" />
      <target name="makeBean" />
      <target name="makeSchemaAccessor" />
      <target name="makeReleaseConfig" />
      <target name="makeModule" />
    </ant>
    <property file="./module.properties" />
    <copy file="${release.dir}/work/${release.dir}/${war.name}.war" tofile="${release.dir}/${war.name}.war" overwrite="true" />
  </target>

<!--
  <target name="makeModule" description="現在の状態でモジュールを作成する">
    <mkdir dir="${release.dir}" />
    <delete>
      <fileset dir="${release.dir}/" includes="**/*"/>
    </delete>
    <mkdir dir="${release.dir}/classes" />
    <antcall target="do.compile">
      <param name="compile.src.roots"     value="src.real" />
      <param name="compile.classpath"     value="classpath.real" />
      <param name="compile.dest.dir"      value="${release.dir}/classes" />
      <param name="copy.resource.target"  value="copyRealResources" />
    </antcall>
    <war destfile="${release.dir}/${war.name}.war" webxml="${web.root.dir}/WEB-INF/web.xml" update="true">
      <fileset dir="${web.root.dir}">
        <include name="**/*" />
        <exclude name="WEB-INF/lib/**/*" />
        <exclude name="WEB-INF/classes/**/*" />
      </fileset>
      <classes dir="${release.dir}/classes">
        <include name="**/*" />
      </classes>
      <lib dir="${lib.dir}/">
        <include name="*" />
      </lib>
    </war>
  </target>
-->

<!--
  <target name="doIt" description="Javaプログラムを起動する">
    <condition property="parameter" value="" >
      <not>
        <isset property="parameter" />
      </not>
    </condition>
    <condition property="vmarg" value="" >
      <not>
        <isset property="vmarg" />
      </not>
    </condition>
    <echo message="${parameter}" />
    <java classname="${target}" fork="yes">
      <arg line="${parameter}" />
      <jvmarg value="${vmarg}" />
      <classpath>
        <pathelement location="${classes.dir}" />
        <fileset dir="${lib.dir}">
          <include name="**/*.jar" />
        </fileset>
        <fileset dir="${other.lib.dir}">
          <include name="**/*.jar" />
        </fileset>
      </classpath>
    </java>
  </target>
-->

  <target name="test" description="JUnit+coberturaでテストを実行する" depends="test.prepare, test.compile">
    <taskdef classpath="${other.lib.dir}/cobertura.jar" resource="tasks.properties">
      <classpath refid="classpath.all" />
    </taskdef>
    <mkdir dir="${test.classes.dir}_tmp" />
    <delete>
      <fileset dir="${test.classes.dir}_tmp" includes="**/*"/>
    </delete>
    <antcall target="copyCoberturaTargetDefault" />
    <antcall target="copyCoberturaTarget" />
    <cobertura-instrument todir="${test.classes.dir}" datafile="${cobertura.ser}">
      <fileset dir="${test.classes.dir}_tmp">
        <include name="**/*.class"/>
      </fileset>
    </cobertura-instrument>
    <antcall target="doJUnit" />
  </target>

  <target name="copyCoberturaTargetDefault" unless="copy.cobertura.target.name" >
    <copy todir="${test.classes.dir}_tmp">
      <fileset dir="${test.classes.dir}">
        <include name="**/*.class" />
        <exclude name="**/*Test.class" />
      </fileset>
    </copy>
  </target>

  <target name="copyCoberturaTarget" if="copy.cobertura.target.name">
    <antcall target="${copy.cobertura.target.name}" />
  </target>

  <target name="doJUnit">
    <taskdef name="junit" classpathref="classpath.all"
                      classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" />
    <junit printsummary="yes" haltonfailure="no" 
          fork="yes" forkmode="once" showOutput="true" failureproperty="tests.failed" maxmemory="1024m">
      <classpath>
        <pathelement location="${test.classes.dir}"/>
        <path refid="classpath.all"/>
      </classpath>
      <formatter type="xml" />
      <batchtest fork="yes" todir="${result.dir}"
                    failureproperty="tests.failed">
        <fileset dir="${test.src.dir}">
          <include name="${junit.src.pattern}" />
        </fileset>
      </batchtest>
    </junit>
    <tstamp>
      <format property="ts" pattern="yyyyMMdd-HHmmss" />
    </tstamp>
    <mkdir dir="${test.root.dir}/${ts}/${report.dir}" />
    <mkdir dir="${test.root.dir}/${ts}/${coverage.dir}" />
    <mkdir dir="${test.root.dir}/${ts}/${coverage.dir}/xml" />
    <junitreport todir="${test.root.dir}/${ts}/${report.dir}">
      <fileset dir="${result.dir}"
          includes="TEST-*.xml"/>
      <report todir="${test.root.dir}/${ts}/${report.dir}" format="frames" /> 
    </junitreport>
    <cobertura-report srcdir="${src.dir}" sourceEncoding="Windows-31J"  destdir="${test.root.dir}/${ts}/${coverage.dir}"/>
    <cobertura-report format="xml" srcdir="${src.dir}"                  destdir="${test.root.dir}/${ts}/${coverage.dir}/xml" />
    <mkdir dir="${test.root.dir}/leatest" />
    <delete>
      <fileset dir="${test.root.dir}/leatest" includes="**/*" />
    </delete>
    <mkdir dir="${test.root.dir}/leatest/junit" />
    <copy todir="${test.root.dir}/leatest/junit">
      <fileset dir="${test.root.dir}/${ts}/${report.dir}" includes="**/*" />
    </copy>
    <mkdir dir="${test.root.dir}/leatest/coverage" />
    <copy todir="${test.root.dir}/leatest/coverage">
      <fileset dir="${test.root.dir}/${ts}/${coverage.dir}" includes="**/*" />
    </copy>
  </target>

  <target name="copyRealResources">
    <copy todir="${resource.dest.dir}" overwrite="true">
      <fileset dir="${src.dir}">
        <exclude name="**/_svn/**" />
        <exclude name="**/.svn/**" />
        <exclude name="**/*.java" />
      </fileset>
    </copy>
  </target>

  <target name="copyAllResources">
    <antcall target="copyRealResources">
      <param name="resource.dest.dir" value="${resource.dest.dir}" />
    </antcall>
    <copy todir="${resource.dest.dir}" overwrite="true">
      <fileset dir="${test.src.dir}">
        <exclude name="**/_svn/**" />
        <exclude name="**/.svn/**" />
        <exclude name="**/*.java" />
      </fileset>
    </copy>
  </target>

  <target name="initAspectJTask">
    <taskdef classpathref="framework.path" resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties" />
  </target>

  <target name="javadoc" description="JavaDocを生成する" if="javadoc.title">
    <delete dir="${javadoc.dir}" />
    <mkdir dir="${javadoc.dir}" />
    <javadoc
          destdir="${javadoc.dir}"
          encoding="Windows-31J"
          docencoding="Windows-31J"
          author="true"
          version="true"
          use="true"
          windowtitle="${javadoc.title}">
      <packageset  dir="${src.dir}" defaultexcludes="yes">
        <include name="jp/rough_diamond/**/*"/>
      </packageset >
      <classpath>
        <path refid="classpath.real"/>
        <fileset dir="${other.lib.dir}">
          <include name="**/*.jar" />
        </fileset>
      </classpath>
    </javadoc>
  </target>

  <target name="makeConfigBase" depends="init-task">
    <propertyChecker base="${conf.dir}/filtering.default.properties" target="${filtering.filename}" />
    <basename property="conf.target.name" file="${filtering.filename}" />
    <dirname property="conf.target.dir" file="${filtering.filename}" />
    <mkdir dir="${conf.dir}/tmp" />
    <native2ascii src="${conf.target.dir}" dest="${conf.dir}/tmp" includes="${conf.target.name}" />
    <filter filtersfile="${conf.dir}/tmp/${conf.target.name}" />
    <copy file="${framework.root}/conf/template/middlegen.properties" tofile="./middlegen.properties" filtering="true" overwrite="true" />
    <delete dir="${conf.dir}/tmp" />
  </target>
</project>
